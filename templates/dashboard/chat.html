{% extends "dashboard/layout.html" %}
{% block content %}
<div id="alert-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;"></div>
<div class="chat-app-wrapper">

    <div class="chat-header-bar">
        <div class="d-flex align-items-center">
           
            <div>
                <h6 class="mb-0 fw-bold">TechNest Community Chat</h6>
                <span class="badge-role">{{ user_role }}</span>
            </div>
        </div>
        <div class="header-status">
            <span class="online-dot"></span> 24h Active
        </div>
    </div>

    <div id="chat-window" class="chat-scroll-area">
        {% for msg in chat_history %}
        {% set is_comp = msg.sender_role == 'company' %}
        <div class="msg-row {{ 'row-right' if is_comp else 'row-left' }}">
            <div class="msg-bubble {{ 'bubble-gold' if is_comp else 'bubble-blue' }}">
                <div class="msg-meta">
                    {# Use the is_comp variable here to stay consistent #}
                    <a href="{{ url_for('view_member_profile', role=msg.sender_role, member_id=msg.sender_member_id) }}"
                        class="msg-author-link text-decoration-none d-flex align-items-center" style="color: inherit;">

                        {# Image on the LEFT for individuals #}
                        {% if not is_comp %}
                        <img src="{{ msg.avatar }}" class="rounded-circle me-1" width="20" height="20"
                            onerror="this.src='/static/default-user.png'">
                        {% endif %}

                        <span class="msg-author" style="font-weight:bold;">{{ msg.display_name }}</span>

                        {# Image on the RIGHT for companies #}
                        {% if is_comp %}
                        <img src="{{ msg.avatar }}" class="rounded-circle ms-1" width="20" height="20"
                            onerror="this.src='/static/default-logo.png'">
                        {% endif %}
                    </a>
                </div>

                {% if msg.message and msg.message != "None" and msg.message != "" %}
                <div class="msg-text">{{ msg.message }}</div>
                {% endif %}

                {% if msg.file_path %}
                <div class="mt-2">
                    {# Check if the file is an image #}
                    {% if msg.file_path.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.webp')) %}
                    <img src="{{ msg.file_path }}" class="img-fluid rounded shadow-sm"
                        style="max-height: 200px; cursor: pointer;" onclick="window.open(this.src)">
                    {% else %}
                    {# It's a document (PDF, DOCX, etc) #}
                    <div
                        class="p-2 rounded border {{ 'bg-white bg-opacity-25' if is_comp else 'bg-dark bg-opacity-10' }}">
                        <a href="{{ msg.file_path }}" target="_blank"
                            class="text-decoration-none d-flex align-items-center {{ 'text-dark' if is_comp else 'text-white' }}">
                            <i class="bi bi-file-earmark-arrow-down-fill fs-4 me-2"></i>
                            <span class="small text-truncate" style="max-width: 150px;">{{ msg.file_name }}</span>
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <div class="msg-time">{{ msg.formatted_time }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="chat-input-bar">
        <div id="emoji-picker" class="emoji-picker-panel d-none">
            <span class="emoji">ğŸ˜€</span><span class="emoji">ğŸ˜ƒ</span><span class="emoji">ğŸ˜„</span><span
                class="emoji">ğŸ˜</span>
            <span class="emoji">ğŸ˜†</span><span class="emoji">ğŸ˜…</span><span class="emoji">ğŸ˜‚</span><span
                class="emoji">ğŸ¤£</span>
            <span class="emoji">ğŸ˜Š</span><span class="emoji">ğŸ˜‡</span><span class="emoji">ğŸ™‚</span><span
                class="emoji">ğŸ™ƒ</span>
            <span class="emoji">ğŸ˜‰</span><span class="emoji">ğŸ˜Œ</span><span class="emoji">ğŸ˜</span><span
                class="emoji">ğŸ¥°</span>
            <span class="emoji">ğŸ˜˜</span><span class="emoji">ğŸ˜—</span><span class="emoji">ğŸ˜™</span><span
                class="emoji">ğŸ˜š</span>
            <span class="emoji">ğŸ˜‹</span><span class="emoji">ğŸ˜›</span><span class="emoji">ğŸ˜</span><span
                class="emoji">ğŸ˜œ</span>
            <span class="emoji">ğŸ¤ª</span><span class="emoji">ğŸ¤¨</span><span class="emoji">ğŸ§</span><span
                class="emoji">ğŸ¤“</span>
            <span class="emoji">ğŸ˜</span><span class="emoji">ğŸ¤©</span><span class="emoji">ğŸ¥³</span><span
                class="emoji">ğŸ˜</span>
            <span class="emoji">ğŸ˜’</span><span class="emoji">ğŸ˜</span><span class="emoji">ğŸ˜”</span><span
                class="emoji">ğŸ˜Ÿ</span>
            <span class="emoji">ğŸ§¡</span><span class="emoji">ğŸ’™</span><span class="emoji">ğŸ‘</span><span
                class="emoji">ğŸ”¥</span>
        </div>

        <form id="chat-form" class="input-container">
            <button type="button" id="emoji-btn" class="btn btn-link p-0 me-2 text-secondary shadow-none">
                <i class="bi bi-emoji-smile fs-5"></i>
            </button>

            <label class="attach-btn">
                <i class="bi bi-plus-lg"></i>
                <input type="file" id="file-input" hidden>
            </label>

            <input type="text" id="msg-input" placeholder="Type a message..." autocomplete="off">

            <button type="submit" class="send-btn">
                <i class="bi bi-send-fill"></i>
            </button>
        </form>
    </div>
</div>

<script>
    // Force the page to not scroll globally
    document.body.style.overflow = "hidden";
    // Auto scroll to bottom
    const win = document.getElementById('chat-window');
    win.scrollTop = win.scrollHeight;
    window.addEventListener("pageshow", function (event) {
        var historyTraversal = event.persisted ||
            (typeof window.performance != "undefined" &&
                window.performance.navigation.type === 2);
        if (historyTraversal) {
            // Handle page restore/back button filter
            window.location.reload();
        }
    });
</script>

{% endblock %}